<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>–ò—Å–∫—Ä–∞</title>
    <link rel="stylesheet" href="/static/css/style.css">
    <meta name="csrf-token" th:content="${_csrf.token}">

    <link rel="apple-touch-icon" sizes="180x180" href="/static/favicon/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/static/favicon/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/static/favicon/favicon-16x16.png">
    <link rel="manifest" href="/static/favicon/site.webmanifest">
</head>
<body>

<header>
    <nav>
        <div class="top-left">
            <h1>–ò—Å–∫—Ä–∞</h1>
            <img src="/static/favicon/favicon-32x32.png" alt="–õ–æ–≥–æ—Ç–∏–ø">
        </div>

        <div class="top-right">
            <div th:if="${!isAuthenticated}">
                <a href="/register" class="button">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</a>
                <a href="/login" class="button">–í—Ö–æ–¥</a>
            </div>
            <div th:if="${isAuthenticated}" class="logout-form">
                <a th:href="@{/user/{id}(id=${authedUser.userId()})}" class="user-name" th:text="${authedUser.firstName()}" th:attr="data-authed-user-id=|${authedUser.userId()}|"></a>
                <button onclick="logout()" class="button logout-button">–í—ã–π—Ç–∏</button>
            </div>
        </div>
    </nav>
</header>

<main>
    <p class="hello_message">–ó–Ω–∞–∫–æ–º—å—Ç–µ—Å—å —Å –ø–æ–º–æ—â—å—é –ò—Å–∫—Ä—ã!</p>

    <div class="card-container" th:if="${isAuthenticated}">
        <div th:each="user : ${users}" th:if="${user.userId().longValue() != authedUser.userId().longValue()}">
            <div class="card" th:attr="data-user-id=|${user.userId()}|">
                <div class="card-header">
                    <button class="like-button" data-liked="false">ü§ç</button>
                    <a th:href="@{/chat/{user_id}(user_id=${user.userId()})}" class="message-button hidden">üí¨</a>
                </div>
                <img src="/static/images/default-avatar.jpeg" alt="–§–æ—Ç–æ" class="profile-photo" th:attr="data-user-id=|${user.userId()}|">
                <a th:href="@{/user/{id}(id=${user.userId()})}" th:text="${user.firstName()} + ' ' + ${user.lastName()}">–ò–º—è –§–∞–º–∏–ª–∏—è</a>
                <p th:text="(${user.gender()} == 0 ? '–ú—É–∂—á–∏–Ω–∞' : '–ñ–µ–Ω—â–∏–Ω–∞') + ', ' + ${T(java.time.Period).between(user.birthDate(), T(java.time.LocalDate).now()).getYears()} + ' –ª–µ—Ç'">–ü–æ–ª, –≤–æ–∑—Ä–∞—Å—Ç</p>
                <p th:text="${user.city()}">–ì–æ—Ä–æ–¥</p>
            </div>
        </div>
    </div>
</main>

<script>
    const token = document.querySelector('meta[name="csrf-token"]').content;
    const authed_id = document.querySelectorAll("a[data-authed-user-id]")[0].getAttribute("data-authed-user-id"); // –ü–æ–ª—É—á–∞–µ–º ID —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    const allLikesEndpoint = `/like/${authed_id}`;

    async function logout() {
        // Get the token from cookie
        const cookies = document.cookie.split(';');
        const authCookie = cookies.find(cookie => cookie.trim().startsWith('authToken='));
        const authToken = authCookie ? authCookie.split('=')[1].trim() : null;

        if (authToken) {
            try {
                const response = await fetch('/api/auth/logout', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRF-TOKEN': token,
                        'Authorization': `Bearer ${authToken}`
                    }
                });
                if (response.ok) {
                    document.cookie = 'authToken=; path=/; max-age=0; SameSite=Strict';
                    window.location.href = '/';
                } else {
                    console.error('Logout failed:', response.statusText);
                    alert('–ù–µ —É–¥–∞–ª–æ—Å—å –≤—ã–π—Ç–∏ –∏–∑ —Å–∏—Å—Ç–µ–º—ã. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.');
                }
            } catch (error) {
                console.error('Logout error:', error);
            }
        }
    }

    async function fetchLikes() {
        try {
            const response = await fetch(allLikesEndpoint);
            if (response.ok) {
                return await response.json();
            } else {
                console.error('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –ª–∞–π–∫–∏:', response.statusText);
                return [];
            }
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –ª–∞–π–∫–æ–≤:', error);
            return [];
        }
    }

    async function initializeLikeButtons() {
        const likes = await fetchLikes();
        const likedUserIDs = likes.map(like => like.receiver_id);

        document.querySelectorAll('.card').forEach(card => {
            const receiverID = card.getAttribute('data-user-id');
            const likeButton = card.querySelector('.like-button');

            if (likedUserIDs.includes(Number(receiverID))) {
                likeButton.textContent = '‚ù§Ô∏è';
                likeButton.setAttribute('data-liked', 'true');
            }

            likeButton.addEventListener('click', async () => {
                const isLiked = likeButton.getAttribute('data-liked') === 'true';
                const url = '/like';
                const method = isLiked ? 'DELETE' : 'POST';

                try {
                    const response = await fetch(url, {
                        method: method,
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRF-TOKEN': token
                        },
                        body: JSON.stringify({ sender_id: authed_id, receiver_id: receiverID, timestamp: Date.now() }),
                    });

                    if (response.ok) {
                        likeButton.textContent = isLiked ? 'ü§ç' : '‚ù§Ô∏è';
                        likeButton.setAttribute('data-liked', !isLiked);
                    } else {
                        alert('–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å –ª–∞–π–∫. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.');
                    }
                } catch (error) {
                    console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –ª–∞–π–∫–∞:', error);
                    alert('–ù–µ —É–¥–∞–ª–æ—Å—å –≤—ã–ø–æ–ª–Ω–∏—Ç—å –¥–µ–π—Å—Ç–≤–∏–µ.');
                }
            });
        });
    }

    const matchesEndpoint = `/match/${authed_id}`;

    async function fetchMatches() {
        try {
            const response = await fetch(matchesEndpoint);
            if (response.ok) {
                return await response.json();
            } else {
                console.error('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –º—ç—Ç—á–∏:', response.statusText);
                return [];
            }
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –º—ç—Ç—á–µ–π:', error);
            return [];
        }
    }

    async function initializeMessageButtons() {
        const matches = await fetchMatches();
        const matchedUserIDs = matches.map(match => (match.user_id1 != authed_id) ? match.user_id1 : match.user_id2);

        document.querySelectorAll('.card').forEach(card => {
            const receiverID = card.getAttribute('data-user-id');
            const messageButton = card.querySelector('.message-button');

            if (matchedUserIDs.includes(Number(receiverID))) {
                messageButton.classList.remove('hidden');
            }
        });
    }

    const profilePhotos = document.querySelectorAll(".profile-photo");
    profilePhotos.forEach(photo => {
        const userId = photo.dataset.userId;

        fetch(`/photos/${userId}/primary`)
            .then(response => {
                if (response.ok) {
                    return response.json();
                } else {
                    throw new Error("–§–æ—Ç–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ");
                }
            })
            .then(data => {
                photo.src = `/files/static/images/uploads/${data.fileName}`;
            })
            .catch(error => {
                console.error(`–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–æ—Ç–æ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ${userId}:`, error);
            });
    });

    async function highlightUsersWithSubscription() {
        const now = new Date();
        for (const card of document.querySelectorAll('.card')) {
            const userId = card.getAttribute('data-user-id');
            try {
                const response = await fetch(`/subscription/${userId}`, {
                        method: 'GET',
                        headers: {
                            'X-CSRF-TOKEN': token
                        }
                    }
                );
                if (response.ok) {
                    for (const subscription of await response.json()) {
                        const startAt = new Date(subscription.startAt);
                        const endAt = new Date(subscription.endAt);

                        if (startAt <= now && endAt >= now) {
                            const nameElement = card.querySelector('a[href^="/user/"]');
                            nameElement.classList.add('has-subscription');
                        }
                    }
                }
            } catch (error) {
                console.error(`–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ –ø–æ–¥–ø–∏—Å–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ${userId}:`, error);
            }
        }
    }

    document.addEventListener('DOMContentLoaded', highlightUsersWithSubscription);


    document.addEventListener('DOMContentLoaded', initializeLikeButtons);
    document.addEventListener('DOMContentLoaded', initializeMessageButtons);
</script>
</body>
</html>
